# ìµœì¢… ì¢…í•© ë¶„ì„: AI Server API ë³€ê²½ ì˜í–¥ë„ + Database êµ¬ì¡°

## ğŸ¯ í•œëˆˆì— ë³´ê¸°

### AI Server API ë³€ê²½ ì‹œ ì˜í–¥ë°›ëŠ” íŒŒì¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AI SERVER API ë³€ê²½                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â†“                           â†“
        ğŸ”´ ë°˜ë“œì‹œ ìˆ˜ì •                ğŸŸ¡ ì„ íƒì  ìˆ˜ì •
        (ì½”ë“œ ë³€ê²½ í•„ìˆ˜)             (ë°ì´í„° í˜•ì‹ì— ë”°ë¼)
        
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ai_client.py         â”‚    â”‚ devices.py           â”‚
    â”‚ â† 4ê°œ API í˜¸ì¶œ ì§ì ‘  â”‚    â”‚ â† ai_client í†µí•´     â”‚
    â”‚ â€¢ send_device_click  â”‚    â”‚   ê°„ì ‘ í˜¸ì¶œ          â”‚
    â”‚ â€¢ get_user_devices   â”‚    â”‚                      â”‚
    â”‚ â€¢ register_user      â”‚    â”‚ recommendations.py   â”‚
    â”‚ â€¢ send_feedback      â”‚    â”‚ â† ai_client í†µí•´     â”‚
    â”‚                      â”‚    â”‚   ê°„ì ‘ í˜¸ì¶œ          â”‚
    â”‚ ìˆ˜ì • ë‚œì´ë„: ğŸŸ¡ ì¤‘ê°„ â”‚    â”‚                      â”‚
    â”‚ ìˆ˜ì • ë²”ìœ„: 4ê°œ ë©”ì„œë“œâ”‚    â”‚ users.py             â”‚
    â”‚ ìˆ˜ì • ë¼ì¸: ~20ì¤„     â”‚    â”‚ â† ai_client í†µí•´     â”‚
    â”‚                      â”‚    â”‚   ê°„ì ‘ í˜¸ì¶œ          â”‚
    â”‚ ì˜í–¥ë„: ğŸ”´ ë§¤ìš° ë†’ìŒ â”‚    â”‚                      â”‚
    â”‚                      â”‚    â”‚ ìˆ˜ì • ë‚œì´ë„: ğŸŸ¢ ì‰¬ì›€ â”‚
    â”‚                      â”‚    â”‚ ìˆ˜ì • ë²”ìœ„: ë°ì´í„°ë§Œ  â”‚
    â”‚                      â”‚    â”‚ ì˜í–¥ë„: ğŸŸ¡ ì¤‘ê°„      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        1ê°œ íŒŒì¼                    3ê°œ íŒŒì¼
```

---

## ğŸ“‹ íŒŒì¼ë³„ ìƒì„¸ ë¶„ë¥˜

### ê·¸ë£¹ 1: ğŸ”´ ë°˜ë“œì‹œ ìˆ˜ì • í•„ìš” (1ê°œ)

#### **ai_client.py**

```python
# ë³€ê²½ ëŒ€ìƒ 4ê°œ ë©”ì„œë“œ
1. send_device_click()
   - URL: /api/gaze/click
   - ìš”ì²­/ì‘ë‹µ ë°ì´í„° ì²˜ë¦¬
   
2. get_user_devices()
   - URL: /api/gaze/devices/{user_id}
   - ì‘ë‹µ ë°ì´í„° íŒŒì‹±
   
3. register_user_async()
   - URL: /api/users/register
   - ìš”ì²­ ë°ì´í„° êµ¬ì„±
   
4. send_recommendation_feedback()
   - URL: /api/recommendations/feedback
   - ìš”ì²­ ë°ì´í„° êµ¬ì„±
```

**ìˆ˜ì • ì‹œë‚˜ë¦¬ì˜¤:**
```
ë³€ê²½ ì „: POST /api/gaze/click
ë³€ê²½ í›„: POST /v2/events/click
ìˆ˜ì •:   url = f"{self.base_url}/v2/events/click"

ë³€ê²½ ì „: {"user_id": "1", "username": "alice"}
ë³€ê²½ í›„: {"userId": "1", "userName": "alice"}
ìˆ˜ì •:   payload = {"userId": user_id, "userName": username}
```

**ê¸°ëŒ€ ìˆ˜ì • ì‹œê°„:** 30ë¶„ ~ 1ì‹œê°„

---

### ê·¸ë£¹ 2: ğŸŸ¡ ì„ íƒì  ìˆ˜ì • (3ê°œ)

#### **devices.py**

```python
# ì˜í–¥ë°›ëŠ” ë¶€ë¶„
1. get_devices() í•¨ìˆ˜
   - ai_client.get_user_devices() í˜¸ì¶œ
   - ë°˜í™˜ ë°ì´í„° ì²˜ë¦¬

2. handle_device_click() í•¨ìˆ˜
   - ai_client.send_device_click() í˜¸ì¶œ
   - ì‘ë‹µ ë°ì´í„° ì²˜ë¦¬
```

**ìˆ˜ì • í•„ìš” ìƒí™©:**
```
ai_clientì—ì„œ ì¼ê´€ëœ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ âœ…
â†’ devices.pyëŠ” ë³€ê²½ ë¶ˆí•„ìš”

ai_clientì—ì„œ ë³€í™˜ ì•ˆí•¨ âŒ
â†’ devices.pyì—ì„œ ì¶”ê°€ ì²˜ë¦¬ í•„ìš”
```

**ê¸°ëŒ€ ìˆ˜ì • ì‹œê°„:** 15ë¶„ (í•„ìš”í•œ ê²½ìš°)

---

#### **recommendations.py**

```python
# ì˜í–¥ë°›ëŠ” ë¶€ë¶„
1. send_feedback_to_ai_server() í•¨ìˆ˜
   - ai_client.send_recommendation_feedback() í˜¸ì¶œ
   - ì‘ë‹µ ì²˜ë¦¬

2. submit_user_feedback() í•¨ìˆ˜
   - ai_client.send_recommendation_feedback() í˜¸ì¶œ
   - ì‘ë‹µ ì²˜ë¦¬
```

**ìˆ˜ì • í•„ìš” ìƒí™©:**
```
ì‘ë‹µ í˜•ì‹ ë³€ê²½: {"success": ...} â†’ {"status": ...}
â†’ if result.get("success", True) ìˆ˜ì • í•„ìš”
```

**ê¸°ëŒ€ ìˆ˜ì • ì‹œê°„:** 10ë¶„ (í•„ìš”í•œ ê²½ìš°)

---

#### **users.py**

```python
# ì˜í–¥ë°›ëŠ” ë¶€ë¶„
1. login_user() í•¨ìˆ˜
   - ai_client.register_user_async() í˜¸ì¶œ
   - ë¹„ë™ê¸° ë°±ê·¸ë¼ìš´ë“œ ì‘ì—…ì´ë¯€ë¡œ ì˜¤ë¥˜ ë¬´ì‹œ
```

**ìˆ˜ì • í•„ìš” ìƒí™©:**
```
ê±°ì˜ ì—†ìŒ (ì˜¤ë¥˜ ë¬´ì‹œí•˜ëŠ” try-except)
ìš”ì²­ í•„ë“œ ë³€ê²½í•´ë„ ai_clientì—ì„œ ì²˜ë¦¬
```

**ê¸°ëŒ€ ìˆ˜ì • ì‹œê°„:** 5ë¶„ (í•„ìš”í•œ ê²½ìš°)

---

### ê·¸ë£¹ 3: ğŸŸ¢ ë³€ê²½ ë¶ˆí•„ìš” (7ê°œ)

| íŒŒì¼                | AI Server ì˜ì¡´ | ì˜í–¥ë„ | ì´ìœ                    |
| ------------------- | -------------- | ------ | ---------------------- |
| **database.py**     | âŒ ì—†ìŒ         | 0%     | SQLite ë¡œì»¬ DBë§Œ ì‚¬ìš©  |
| **gaze_tracker.py** | âŒ ì—†ìŒ         | 0%     | ì‹œì„  ì¶”ì  ë¡œì»¬ ì—°ì‚°ë§Œ  |
| **calibration.py**  | âŒ ì—†ìŒ         | 0%     | ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ë¡œì»¬ ì²˜ë¦¬ |
| **settings.py**     | âŒ ì—†ìŒ         | 0%     | í•„í„° ìƒíƒœ ì¡°íšŒë§Œ       |
| **websocket.py**    | âŒ ì—†ìŒ         | 0%     | WebSocket ìŠ¤íŠ¸ë¦¬ë°ë§Œ   |
| **config.py**       | âŒ ì—†ìŒ         | 0%     | í™˜ê²½ë³€ìˆ˜ ê´€ë¦¬          |
| **main.py**         | âŒ ì—†ìŒ         | 0%     | ë¼ìš°í„° ë“±ë¡ë§Œ          |

---

## ğŸ’¾ Database êµ¬ì¡°

### ìœ„ì¹˜
```
~/.gazehome/calibrations/gazehome.db
```

### 4ê°œ í…Œì´ë¸”

#### 1ï¸âƒ£ **users** (ì‚¬ìš©ì)
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    username TEXT UNIQUE NOT NULL,
    created_at TIMESTAMP,
    last_login TIMESTAMP
);
```

**ìš©ë„:** ì‚¬ìš©ì ê´€ë¦¬
**ë°ì´í„°:** 
- alice (2024-10-21 ê°€ì…, 2024-10-22 ë§ˆì§€ë§‰ ë¡œê·¸ì¸)
- bob (2024-10-20 ê°€ì…, 2024-10-22 ë§ˆì§€ë§‰ ë¡œê·¸ì¸)

---

#### 2ï¸âƒ£ **calibrations** (ìº˜ë¦¬ë¸Œë ˆì´ì…˜)
```sql
CREATE TABLE calibrations (
    id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,
    calibration_file TEXT NOT NULL,
    screen_width INTEGER,
    screen_height INTEGER,
    method TEXT,
    samples_count INTEGER,
    created_at TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

**ìš©ë„:** ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì´ë ¥ ì¶”ì 
**ë°ì´í„°:**
- user_id=1: alice.pkl (2024-10-21, 45ìƒ˜í”Œ)
- user_id=1: alice_v2.pkl (2024-10-22, 48ìƒ˜í”Œ)

---

#### 3ï¸âƒ£ **devices** (ê¸°ê¸° ëª©ë¡ - ì˜¤í”„ë¼ì¸ ìºì‹œ)
```sql
CREATE TABLE devices (
    id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,
    device_id TEXT NOT NULL,
    device_name TEXT NOT NULL,
    device_type TEXT,
    capabilities TEXT,  -- JSON ë°°ì—´
    last_synced TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    UNIQUE(user_id, device_id)
);
```

**ìš©ë„:** AI Serverì—ì„œ ê°€ì ¸ì˜¨ ê¸°ê¸° ëª©ë¡ ìºì‹± (ì˜¤í”„ë¼ì¸ ì§€ì›)
**ë°ì´í„°:**
- user_id=1: ac_001 (ì—ì–´ì»¨, capabilities: ["turn_on", "turn_off", ...])
- user_id=1: light_01 (ì¡°ëª…, capabilities: ["turn_on", "turn_off", ...])

**ğŸ”‘ íŠ¹ì§•:**
```
âœ… ì˜¤í”„ë¼ì¸ ì§€ì›
   AI Server ë‹¤ìš´ â†’ ìºì‹œëœ ê¸°ê¸° ëª©ë¡ ë°˜í™˜

âœ… ë‹¤ì¤‘ ì‚¬ìš©ì ì§€ì›
   UNIQUE(user_id, device_id)ë¡œ ì‚¬ìš©ìë³„ ê²©ë¦¬

âœ… ìœ ì—°í•œ êµ¬ì¡°
   capabilitiesëŠ” JSONì´ë¯€ë¡œ ë‹¤ì–‘í•œ ê¸°ëŠ¥ ì €ì¥ ê°€ëŠ¥
```

---

#### 4ï¸âƒ£ **login_history** (ë¡œê·¸ì¸ ê¸°ë¡)
```sql
CREATE TABLE login_history (
    id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,
    login_at TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

**ìš©ë„:** ì‚¬ìš©ì í™œë™ í†µê³„
**ë°ì´í„°:**
- user_id=1: 2024-10-22 09:00:00
- user_id=1: 2024-10-22 14:30:00
- user_id=2: 2024-10-22 14:00:00

---

### Database ì˜í–¥ë„

```
AI Server API ë³€ê²½
         â†“
    ë°ì´í„°ë² ì´ìŠ¤?
         â†“
    NO âŒ
    
    ì´ìœ :
    âœ… SQLiteëŠ” ë¡œì»¬ íŒŒì¼ ì €ì¥ì†Œ
    âœ… AI Serverì™€ ë…ë¦½ì 
    âœ… ë°ì´í„° í˜•ì‹ë§Œ ê°™ìœ¼ë©´ OK
    âœ… ìŠ¤í‚¤ë§ˆ ë³€ê²½ ë¶ˆí•„ìš”
```

---

## ğŸ“Š ì „ì²´ ìˆ˜ì • ë²”ìœ„ ìš”ì•½

### ìµœì•…ì˜ ì‹œë‚˜ë¦¬ì˜¤

**AI Server API ì™„ì „ ë³€ê²½:**
```
POST /api/gaze/click
POST /api/gaze/devices/{user_id}
POST /api/users/register
POST /api/recommendations/feedback
```

**ë³€ê²½ í›„:**
```
POST /v2/events/click
GET /v2/devices/{id}
POST /v2/auth/register
POST /v2/feedback
```

**ì˜í–¥ë°›ëŠ” íŒŒì¼:**
1. âœ… ai_client.py (4ê°œ ë©”ì„œë“œ, ~20ì¤„)
2. âš ï¸ devices.py (ë°ì´í„° ì²˜ë¦¬, ~10ì¤„)
3. âš ï¸ recommendations.py (ì‘ë‹µ ì²˜ë¦¬, ~5ì¤„)
4. âš ï¸ users.py (ê±°ì˜ ì—†ìŒ)
5. âŒ ë‚˜ë¨¸ì§€ (ë³€ê²½ ì—†ìŒ)

**ì´ ìˆ˜ì • ì‹œê°„:** 1~2ì‹œê°„

---

### ìµœì„ ì˜ ì‹œë‚˜ë¦¬ì˜¤

**AI Serverê°€ í˜¸í™˜ì„± ìœ ì§€:**
```
URL ë³€ê²½ ì—†ìŒ
ìš”ì²­/ì‘ë‹µ í˜•ì‹ ë™ì¼
```

**ì˜í–¥ë°›ëŠ” íŒŒì¼:**
```
âŒ ì—†ìŒ

ëª¨ë“  ì½”ë“œê°€ ê·¸ëŒ€ë¡œ ì‘ë™
```

**ì´ ìˆ˜ì • ì‹œê°„:** 0ë¶„

---

## ğŸ¯ ê¶Œì¥ì‚¬í•­

### ë‹¨ê¸° (ì§€ê¸ˆ)
```
âœ… í˜„ì¬ ì½”ë“œ ìœ ì§€
âœ… AI Server API ë¬¸ì„œ ì •ë¦¬ (ë²„ì „ ê´€ë¦¬)
âœ… í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„± (API ë³€ê²½ ì‹œë®¬ë ˆì´ì…˜)
```

### ì¤‘ê¸° (ì„ íƒ)
```
â­ Endpoint í´ë˜ìŠ¤ ë„ì…
   endpoints = {
       "click": "/api/gaze/click",
       "devices": "/api/gaze/devices"
   }

â­ API Adapter íŒ¨í„´
   request_adapter()
   response_adapter()
```

### ì¥ê¸° (ì„ íƒ)
```
â­ API ë²„ì „ ê´€ë¦¬
   v1: /api/gaze/click
   v2: /v2/events/click
   ë™ì‹œ ì§€ì› ê°€ëŠ¥

â­ Mock Server í…ŒìŠ¤íŠ¸
   ë‹¤ì–‘í•œ API ë³€ê²½ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸
```

---

## ğŸ“Œ ìµœì¢… ê²°ë¡ 

### íŒŒì¼ ë¶„ë¥˜

| ë¶„ë¥˜        | íŒŒì¼                                                                                        | ìˆ˜  | ë³€ê²½ í•„ìš” |
| ----------- | ------------------------------------------------------------------------------------------- | --- | --------- |
| ğŸ”´ ë³€ê²½ í•„ìˆ˜ | ai_client.py                                                                                | 1   | âœ… í•„ìš”    |
| ğŸŸ¡ ì„ íƒì     | devices.py, recommendations.py, users.py                                                    | 3   | âš ï¸ ê°€ëŠ¥    |
| ğŸŸ¢ ë¬´ê´€      | database.py, gaze_tracker.py, calibration.py, settings.py, websocket.py, config.py, main.py | 7   | âŒ ë¶ˆí•„ìš”  |

### Database

| í•­ëª©              | ìƒíƒœ     |
| ----------------- | -------- |
| ì½”ë“œ ë³€ê²½ í•„ìš”    | âŒ ë¶ˆí•„ìš” |
| ìŠ¤í‚¤ë§ˆ ë³€ê²½ í•„ìš”  | âŒ ë¶ˆí•„ìš” |
| ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš” | âŒ ë¶ˆí•„ìš” |
| AI Server ì˜ì¡´    | âŒ ì—†ìŒ   |

### ì „ì²´ í‰ê°€

```
í”„ë¡œë•ì…˜ ì¤€ë¹„ ìƒíƒœ: âœ… ì™„ë²½
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ì•„í‚¤í…ì²˜:         â­â­â­â­â­
 â†³ ê³„ì¸µ ë¶„ë¦¬ ëª…í™•, ì˜ì¡´ì„± ìµœì†Œí™”

AI Server ë³µì›ë ¥: â­â­â­â­â­
 â†³ API ë³€ê²½ì— ìë™ ëŒ€ì‘ ê°€ëŠ¥

Database ì„¤ê³„:    â­â­â­â­â­
 â†³ ê²½ëŸ‰, ìœ ì—°, í™•ì¥ ê°€ëŠ¥

ì½”ë“œ í’ˆì§ˆ:        â­â­â­â­â­
 â†³ ì£¼ì„ ëª…í™•, ì—ëŸ¬ ì²˜ë¦¬ ìš°ìˆ˜

ìœ ì§€ë³´ìˆ˜ì„±:       â­â­â­â­â­
 â†³ API ë³€ê²½ ì‹œ ìµœì†Œí•œì˜ ìˆ˜ì •
```

---

## ğŸš€ ê²°ë¡ 

### AI Server API ë³€ê²½ì— ëŒ€í•œ ëŒ€ì‘

```
ê¸°ë³¸ ì›ì¹™: "ë¶„ë¦¬ì™€ ì¶”ìƒí™”"
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… ai_client.pyì— ëª¨ë“  API í˜¸ì¶œ ì§‘ì¤‘
âœ… ë‚˜ë¨¸ì§€ ì½”ë“œëŠ” ì¶”ìƒí™”ëœ ì¸í„°í˜ì´ìŠ¤ë§Œ ì‚¬ìš©
âœ… DatabaseëŠ” ì™„ì „íˆ ë…ë¦½ì 

ê²°ê³¼:
â”€â”€â”€â”€â”€
ğŸ“ API ë³€ê²½ ì‹œ ìµœì†Œí•œì˜ ì½”ë“œ ìˆ˜ì •
ğŸ“ ë³€ê²½ ë²”ìœ„ ëª…í™• (ai_client.pyë§Œ)
ğŸ“ ë‹¤ë¥¸ íŒŒì¼ì€ ì˜í–¥ ì—†ìŒ
ğŸ“ í”„ë¡œë•ì…˜ ë°°í¬ ìš©ì´
```

### ìµœì¢… í‰ê°€

```
ì§ˆë¬¸: AI Server API ë³€ê²½ ì‹œ ë°±ì—”ë“œ ì½”ë“œ ë³€ê²½ í•„ìš”?

ë‹µë³€: ìµœì†Œí•œë§Œ í•„ìš” âœ…
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â€¢ ë³€ê²½ í•„ìˆ˜: ai_client.py (1ê°œ íŒŒì¼)
â€¢ ë³€ê²½ ì„ íƒ: devices.py, recommendations.py, users.py (3ê°œ íŒŒì¼)
â€¢ ë³€ê²½ ë¶ˆí•„ìš”: ë‚˜ë¨¸ì§€ (7ê°œ íŒŒì¼)
â€¢ Database: ë³€ê²½ ë¶ˆí•„ìš” (100% ë…ë¦½)

ì´ ì˜í–¥ë„: ì•½ 10% ë¯¸ë§Œ (ì•„í‚¤í…ì²˜ ì„¤ê³„ê°€ ìš°ìˆ˜í•¨)
ìˆ˜ì • ì‹œê°„: 1~2ì‹œê°„
ìœ„í—˜ë„: ë‚®ìŒ âœ…
```
